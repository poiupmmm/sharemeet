<view class="activity-detail-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading">åŠ è½½ä¸­...</view>
  </view>

  <!-- é”™è¯¯æç¤º -->
  <view class="error-container" wx:if="{{!loading && errorMessage}}">
    <view class="error-box">
      <view class="error-title">{{errorMessage}}</view>
      <button class="primary-button" bindtap="handleBack">è¿”å›ä¸Šä¸€é¡µ</button>
    </view>
  </view>

  <!-- æ´»åŠ¨ä¸å­˜åœ¨ -->
  <view class="not-found-container" wx:if="{{!loading && !activity && !errorMessage}}">
    <view class="not-found-box">
      <view class="not-found-title">æœªæ‰¾åˆ°æ´»åŠ¨</view>
      <view class="not-found-desc">è¯¥æ´»åŠ¨ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</view>
      <button class="primary-button" bindtap="handleBack">è¿”å›æ´»åŠ¨åˆ—è¡¨</button>
    </view>
  </view>

  <!-- æ´»åŠ¨è¯¦æƒ… -->
  <block wx:if="{{!loading && activity}}">
    <!-- é¡¶éƒ¨å›¾ç‰‡ -->
    <view class="activity-image">
      <image 
        src="{{activity.imageUrl || '/assets/images/default-activity.png'}}"
        mode="aspectFill" 
        class="cover-image"
      ></image>
      <view class="back-button" bindtap="handleBack">
        <text class="back-icon">â—€</text>
      </view>
      <view class="share-button" bindtap="onShareAppMessage">
        <text class="share-icon">âŠ•</text>
      </view>
    </view>

    <!-- æ´»åŠ¨å†…å®¹ -->
    <view class="activity-content">
      <view class="badge">{{activity.category}}</view>
      <view class="title">{{activity.title}}</view>
      
      <!-- æ´»åŠ¨ä¿¡æ¯é¡¹ -->
      <view class="info-item">
        <view class="info-icon">ğŸ—“ï¸</view>
        <view class="info-content">
          <text class="info-label">æ—¶é—´</text>
          <text class="info-value">{{activity.date}}</text>
        </view>
      </view>
      
      <view class="info-item">
        <view class="info-icon">ğŸ“</view>
        <view class="info-content">
          <text class="info-label">åœ°ç‚¹</text>
          <view class="location-row">
            <text class="info-value">{{activity.city ? activity.city + ' ' + activity.location : activity.location}}</text>
            <view class="map-button" bindtap="showMap">æŸ¥çœ‹åœ°å›¾</view>
          </view>
        </view>
      </view>
      
      <view class="info-item">
        <view class="info-icon">ğŸ’°</view>
        <view class="info-content">
          <text class="info-label">è´¹ç”¨</text>
          <text class="info-value">{{activity.price === '0' ? 'å…è´¹' : activity.price}}</text>
        </view>
      </view>
      
      <view class="info-item">
        <view class="info-icon">ğŸ‘¥</view>
        <view class="info-content">
          <text class="info-label">å‚ä¸äººæ•°</text>
          <view class="participants-info">
            <text class="info-value">{{participants.length || 1}}äºº</text>
            <text class="limit-tag" wx:if="{{activity.max_participants}}">ä¸Šé™{{activity.max_participants}}äºº</text>
          </view>
        </view>
      </view>
      
      <!-- æ´»åŠ¨è¯¦æƒ… -->
      <view class="section">
        <view class="section-title">æ´»åŠ¨è¯¦æƒ…</view>
        <text class="description">{{activity.description}}</text>
      </view>
      
      <!-- å‚ä¸è€…åˆ—è¡¨ -->
      <view class="section">
        <view class="section-title">å·²æŠ¥å ({{participants.length || 1}})</view>
        <view class="participants-list">
          <view class="participant-item" wx:for="{{participants}}" wx:key="id">
            <image class="participant-avatar" src="{{item.avatar_url || '/assets/images/default-avatar.png'}}"></image>
            <text class="participant-name">{{item.username || 'ç”¨æˆ·'+index}}</text>
          </view>
          <!-- å¦‚æœæ²¡æœ‰å‚ä¸è€…ï¼Œæ˜¾ç¤ºåˆ›å»ºè€… -->
          <view class="participant-item" wx:if="{{participants.length === 0}}">
            <image class="participant-avatar" src="{{creatorInfo.avatar_url || '/assets/images/default-avatar.png'}}"></image>
            <text class="participant-name">{{creatorInfo.username || 'åˆ›å»ºè€…'}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- æ´»åŠ¨æŒ‰é’®åŒºåŸŸ -->
    <view class="action-container">
      <block wx:if="{{isCreator}}">
        <button class="primary-button" bindtap="handleEdit">ç¼–è¾‘æ´»åŠ¨</button>
      </block>
      <block wx:else>
        <button 
          class="{{hasJoined ? 'secondary-button' : 'primary-button'}}" 
          disabled="{{joining || leaving}}"
          bindtap="{{hasJoined ? 'handleLeave' : 'handleJoin'}}"
        >
          {{joining ? 'æŠ¥åä¸­...' : (leaving ? 'é€€å‡ºä¸­...' : (hasJoined ? 'é€€å‡ºæ´»åŠ¨' : 'ç«‹å³æŠ¥å'))}}
        </button>
      </block>
      <view class="error-message" wx:if="{{errorMessage}}">{{errorMessage}}</view>
    </view>
  </block>

  <!-- åœ°å›¾å¼¹çª— -->
  <view class="map-modal" wx:if="{{showMap && activity}}">
    <view class="map-container">
      <view class="map-header">
        <text class="map-title">æ´»åŠ¨åœ°ç‚¹</text>
        <view class="close-button" bindtap="hideMap">âœ–</view>
      </view>
      
      <!-- ä½¿ç”¨è…¾è®¯åœ°å›¾ -->
      <map
        id="activityMap"
        longitude="{{longitude}}"
        latitude="{{latitude}}"
        markers="{{markers}}"
        scale="16"
        style="width: 100%; height: 300px;"
        show-location
      ></map>
      
      <view class="map-footer">
        <view class="address-info">
          åœ°å€ï¼š{{activity.city ? activity.city + ' ' + activity.location : activity.location}}
        </view>
        <view class="button-row">
          <button class="navigate-button" bindtap="navigateToLocation">å¯¼èˆª</button>
          <button class="close-map-button" bindtap="hideMap">å…³é—­</button>
        </view>
      </view>
    </view>
  </view>
</view> 